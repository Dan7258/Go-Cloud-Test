# Вопросы для разогрева

1. На данный момент, самой интересной задачей в программировании является написание практической части диплома. Никогда не писал такой большой проект. Проект постоянно растет и появляются все недочеты моей разработки.
2. При написании makefile я неверно написал команду для очистки ненужных файлов. Конечно же почти все файлы удалились. Большую часть файлов удалось восстановить с помощью VS Code, но некоторые пришлось подгружать заново с gitlab и исправлять все ошибки. А все это было под вечер, когда уже ничего не хочется)
3. Мои ожидания от буткемпа: 
   1. Получить опыт на реальных задачах
   2. Познакомиться с новыми людьми
   3. Вырасти как специалист
   4. Получить удовольствие от процесса :)

# Cloud Load Balancer

Проект представляет собой HTTP-балансировщик нагрузки на Go с функционалом ограничения частоты запросов (rate-limiting) на основе алгоритма Token Bucket.

## Функциональность

### Балансировщик нагрузки
- Принимает входящие HTTP-запросы на заданном порту
- Распределяет запросы между несколькими бэкенд-серверами по алгоритму Round-Robin
- Обрабатывает ситуации, когда один или несколько бэкендов недоступны
- Использует горутины для одновременной обработки нескольких запросов
- Реализует логирование запросов и ошибок

### Rate-Limiting
- Реализует алгоритм Token Bucket для ограничения частоты запросов
- Поддерживает индивидуальные настройки лимитов для каждого клиента
- Сохраняет состояние клиентов в PostgreSQL и Redis
- Автоматически пополняет токены с заданной периодичностью
- Предоставляет API для управления клиентами (создание, получение, обновление, удаление)

## Архитектура проекта

Проект разделен на следующие модули:
- `config_handler` - работа с конфигурацией приложения
- `controllers` - обработчики HTTP-запросов для управления клиентами
- `load_balancer` - логика балансировки нагрузки
- `logger` - модуль логирования
- `models` - модели данных и работа с базами данных
- `rate_limiter` - реализация алгоритма Token Bucket

## Требования

- Go 1.23 или выше
- PostgreSQL
- Redis
- Docker и Docker Compose (для запуска в контейнерах)

## Установка и запуск
### Запуск с помощью Docker Compose
## Важно!

### Устанавливайте порт и в файле config.json и в файле compose.yaml

1. Запустите серверы:

2. Запустите серверы по желаемому адресу
```go
package main

import "net/http"

func main() {
	http.ListenAndServe(":8081", nil)
}
```

3. Настройте конфигурационные файлы:
    - `.env` - параметры подключения к БД и Redis
    - `config.json` - параметры балансировщика и rate-limiter
    - `redis.conf` - конфигурация Redis
    - если сервер находится на localhost, то в config.json прописывайте: "host.docker.internal:port" 
4. Запустите приложение с помощью Docker Compose:
```bash
docker-compose up -d
```

### Запуск без Docker

1. Установите и запустите PostgreSQL и Redis

2. Создайте таблицу в PostgreSQL:
```sql
CREATE TABLE rate_limits (
    client_id TEXT PRIMARY KEY,
    capacity INTEGER NOT NULL,
    rate_per_sec INTEGER NOT NULL
);
```

3. Запустите серверы по желаемому адресу
```go
package main

import "net/http"

func main() {
	http.ListenAndServe(":8081", nil)
}
```

4. Настройте конфигурационные файлы:
    - `.env` - параметры подключения к БД и Redis
    - `config.json` - параметры балансировщика и rate-limiter
    - если сервер находится на localhost, то в config.json прописывайте: "localhost:port"

5. Запустите приложение:
```bash
go run main.go
```

## Конфигурация

### Файл .env
```
DB_HOST=cloudDB
DB_USER=cloud
DB_PASSWORD=cloud
DB_NAME=cloudDB
DB_PORT=5432
REDIS_HOST=redis:6379
REDIS_PASSWORD=redis
```

### Файл config.json
```json
{
  "port": "8080",
  "backends": [
    "host.docker.internal:9023",
    "host.docker.internal:8081"
  ],
  "capacity": 100,
  "rate_per_sec": 2
}
```

## API

### Управление клиентами

#### Создание клиента
```
POST /clients/
Content-Type: application/json

{
  "client_id": "192.168.1.1",
  "capacity": 100,
  "rate_per_sec": 10
}
```

#### Получение информации о клиенте
```
GET /clients/{client_id}
```

#### Обновление параметров клиента
```
PATCH /clients/
Content-Type: application/json

{
  "client_id": "192.168.1.1",
  "capacity": 200,
  "rate_per_sec": 20
}
```

#### Удаление клиента
```
DELETE /clients/{client_id}
```

## Логирование

Приложение использует цветное логирование для разных типов сообщений:
- `INFO` (зеленый) - информационные сообщения
- `WARNING` (желтый) - предупреждения
- `ERROR` (красный) - ошибки
- `FATAL` (фиолетовый) - критические ошибки, приводящие к остановке приложения

## Алгоритм работы

1. При запуске приложение:
    - Загружает конфигурацию из файлов
    - Подключается к PostgreSQL и Redis
    - Инициализирует балансировщик нагрузки и rate-limiter
    - Запускает HTTP-сервер и тикер для пополнения токенов

2. При получении HTTP-запроса:
    - Выбирает следующий доступный бэкенд по алгоритму Round-Robin
    - Проверяет доступность бэкенда
    - Получает данные клиента из Redis или БД
    - Проверяет наличие токена в bucket клиента
    - Если токен есть, перенаправляет запрос на бэкенд
    - Если токенов нет, возвращает ошибку 429 (Too Many Requests)
    - Сохраняет обновленные данные клиента в Redis

3. Каждые 30 секунд:
    - Обновляет количество токенов для всех клиентов в Redis
    - Логирует информацию о пополнении токенов
